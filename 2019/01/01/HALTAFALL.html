<!DOCTYPE html>
<html lang="en">
<meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'self' 'unsafe-inline' https://www.youtube.com; style-src 'self' https://fonts.googleapis.com; img-src 'self'; font-src 'self' https://fonts.gstatic.com; connect-src 'self'; media-src 'self' https://www.youtube.com; object-src 'self'; child-src 'self' https://www.youtube.com; form-action 'none'; base-uri 'self'"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, minimum-scale=0.5" />
  <title>mini-HALTAFALL</title><!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="mini-HALTAFALL" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Back to Pages" />
<meta property="og:description" content="Back to Pages" />
<link rel="canonical" href="https://gmcl.se/2019/01/01/HALTAFALL.html" />
<meta property="og:url" content="https://gmcl.se/2019/01/01/HALTAFALL.html" />
<meta property="og:site_name" content="GMCL" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-01-01T01:00:02+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="mini-HALTAFALL" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2019-01-01T01:00:02+01:00","datePublished":"2019-01-01T01:00:02+01:00","description":"Back to Pages","headline":"mini-HALTAFALL","mainEntityOfPage":{"@type":"WebPage","@id":"https://gmcl.se/2019/01/01/HALTAFALL.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://gmcl.se/assets/images/ionic_interactions_bw.jpg"}},"url":"https://gmcl.se/2019/01/01/HALTAFALL.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" type="text/css" href="/assets/main-light.css"><link rel="stylesheet" href="/assets/css/video-embed.css">

</head>
<body>
    <div class="container"><header>
<img class="logo" src="/assets/images/gmcl_logo.jpg" width="360" height="138" />
  <br>
  <div class="menu">
    <ul><li><a href="/">Home</a></li><li><a href="/publications/">Publications</a></li><li><a href="/pages/">Pages</a></li><li><a href="/about/">About</a></li></ul>
  </div>
  
</header>


<main>
      <p><a href="https://gmcl.se/pages/"><em>Back to Pages</em></a></p>

<div class="mini-haltafall" id="mini-haltafall">
  <div class="wrap">
    <h1>Mini HALTAFALL</h1>
    <div class="sub">Client-side equilibrium solver</div>

    <div class="panel">
      <h2>Model (JSON)</h2>
      <textarea id="jsonInput" class="mono" spellcheck="false"></textarea>
      <div class="row" style="margin-top:10px">
        <button id="solveBtn" class="btn">Solve</button>
        <button id="ex1" class="btn secondary">Load: Weak acid (HA)</button>
        <button id="ex2" class="btn secondary">Load: Metal–ligand (M–L)</button>
      </div>
    </div>

    <div class="panel">
      <h2>Results</h2>
      <div id="results" class="out mono">(Solve to see results)</div>
    </div>
  </div>
</div>

<style>
.mini-haltafall { --bg:#000; --text:#00ff7f; --muted:#6affb0; --grid:#00e676; --err:#ff6b6b; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background: var(--bg); color: var(--text); padding: 12px 0; }
.mini-haltafall .wrap { max-width: 820px; margin: 0 auto; padding: 0 14px; }
.mini-haltafall h1 { font-size: 22px; margin: 6px 0 8px; text-transform: uppercase; }
.mini-haltafall h2 { font-size: 16px; margin: 0 0 8px; color: var(--muted); }
.mini-haltafall .panel { background: var(--bg); border: 1px dashed var(--grid); border-radius: 10px; padding: 12px; margin-bottom: 12px; }
.mini-haltafall textarea, .mini-haltafall .out { width:100%; min-height: 400px; padding:10px; border-radius: 8px; background:#001b00; color:var(--text); border:1px solid var(--grid); }
.mini-haltafall .btn { background: #001b00; color: var(--text); border:1px solid var(--grid); padding:8px 12px; border-radius:8px; cursor:pointer; }
.mini-haltafall .btn.secondary { opacity:.9; }
.mini-haltafall .out { white-space: pre-wrap; }
</style>

<script>
(() => {
  const root = document.getElementById('mini-haltafall');
  if (!root) return;

  const log10 = (x) => Math.log(x) / Math.LN10;

  const parseModel = (jsonStr) => {
    const m = JSON.parse(jsonStr);
    if (!Array.isArray(m.components) || m.components.length === 0) throw new Error("components must be a nonempty array");
    if (typeof m.totals !== 'object' || m.totals === null) throw new Error("totals must be an object");
    if (!Array.isArray(m.secondary)) m.secondary = [];
    m.components.forEach(c => { if (!(c in m.totals)) throw new Error("missing total for " + c); });
    m.secondary.forEach(s => { m.components.forEach(c => { if (!(c in s.stoich)) s.stoich[c] = 0; }); });
    return m;
  };

  const secondaryConcs = (model, x) => {
    const concs = [];
    for (const s of model.secondary) {
      let ln = s.logK * Math.LN10;
      for (let j = 0; j < model.components.length; j++) {
        ln += s.stoich[model.components[j]] * Math.log(Math.max(x[j], 1e-40));
      }
      concs.push(Math.exp(ln));
    }
    return concs;
  };

  const residual = (model, x) => {
    const sec = secondaryConcs(model, x);
    const r = new Array(model.components.length).fill(0);
    for (let k = 0; k < model.components.length; k++) {
      let acc = x[k];
      for (let i = 0; i < model.secondary.length; i++) {
        acc += model.secondary[i].stoich[model.components[k]] * sec[i];
      }
      r[k] = acc - model.totals[model.components[k]];
    }
    return { r, sec };
  };

  const norm2 = (v) => Math.sqrt(v.reduce((a, b) => a + b * b, 0));

  const solveSystem = (model, x0) => {
    let x = x0.slice();
    const n = x.length;
    for (let it = 0; it < 100; it++) {
      const { r } = residual(model, x);
      if (norm2(r) < 1e-10) return { x, sec: secondaryConcs(model, x), it, ok: true };
      const J = Array.from({ length: n }, () => new Array(n).fill(0));
      for (let j = 0; j < n; j++) {
        const step = Math.max(1e-6, 1e-6 * Math.abs(x[j]));
        const xh = x.slice();
        xh[j] = Math.max(1e-30, xh[j] + step);
        const { r: rh } = residual(model, xh);
        for (let k = 0; k < n; k++) J[k][j] = (rh[k] - r[k]) / (xh[j] - x[j]);
      }
      const A = J.map((row, k) => row.concat([-r[k]]));
      for (let i = 0; i < n; i++) {
        let piv = i;
        for (let ii = i + 1; ii < n; ii++) if (Math.abs(A[ii][i]) > Math.abs(A[piv][i])) piv = ii;
        if (Math.abs(A[piv][i]) < 1e-30) return { x, sec: secondaryConcs(model, x), it, ok: false };
        if (piv !== i) { const tmp = A[i]; A[i] = A[piv]; A[piv] = tmp; }
        const d = A[i][i];
        for (let j = i; j <= n; j++) A[i][j] /= d;
        for (let ii = 0; ii < n; ii++) if (ii !== i) {
          const f = A[ii][i];
          for (let j = i; j <= n; j++) A[ii][j] -= f * A[i][j];
        }
      }
      const dx = A.map(row => row[n]);
      let alpha = 1.0;
      for (let j = 0; j < n; j++) if (dx[j] < 0) alpha = Math.min(alpha, 0.8 * x[j] / (-dx[j] + 1e-40));
      alpha = Math.max(alpha, 1e-6);
      x = x.map((v, j) => Math.max(1e-40, v + alpha * dx[j]));
    }
    return { x, sec: secondaryConcs(model, x), it: 100, ok: false };
  };

  const prettyResults = (model, sol) => {
    const lines = [];
    lines.push(`Converged: ${sol.ok}`);
    lines.push("");
    lines.push("Free components:");
    for (let j = 0; j < model.components.length; j++) {
      lines.push(`  ${model.components[j]} = ${sol.x[j].toExponential(6)} (p=${(-log10(sol.x[j])).toFixed(3)})`);
    }
    lines.push("");
    lines.push("Secondary species:");
    for (let i = 0; i < model.secondary.length; i++) {
      lines.push(`  ${model.secondary[i].name} = ${sol.sec[i].toExponential(6)}`);
    }
    return lines.join("\n");
  };

  const resultsEl = root.querySelector('#results');
  const inputEl = root.querySelector('#jsonInput');
  const solveBtn = root.querySelector('#solveBtn');
  const ex1Btn = root.querySelector('#ex1');
  const ex2Btn = root.querySelector('#ex2');

  const exWeakAcid = {
    components: ["H+", "A-"],
    totals: {"H+": 1e-7, "A-": 1e-3},
    secondary: [{ name: "HA", logK: 4.75, stoich: {"H+": 1, "A-": 1} }]
  };

  const exMetalLigand = {
    components: ["M2+","L-"],
    totals: {"M2+": 1e-4, "L-": 2e-4},
    secondary: [
      { name: "ML+", logK: 5.0, stoich: {"M2+":1, "L-":1} },
      { name: "ML2", logK: 8.5, stoich: {"M2+":1, "L-":2} }
    ]
  };

  const loadEx = (obj) => { inputEl.value = JSON.stringify(obj, null, 2); };
  const solveFromTextarea = () => {
    try {
      const model = parseModel(inputEl.value);
      const x0 = model.components.map(c => Math.max(1e-9, model.totals[c] * 0.5));
      const sol = solveSystem(model, x0);
      resultsEl.textContent = prettyResults(model, sol);
    } catch (e) {
      resultsEl.textContent = `Error: ${e.message}`;
    }
  };

  solveBtn.addEventListener('click', solveFromTextarea);
  ex1Btn.addEventListener('click', () => loadEx(exWeakAcid));
  ex2Btn.addEventListener('click', () => loadEx(exMetalLigand));
  loadEx(exWeakAcid);
})();
</script>



    </main><footer>
  <div class="footer-container">
    <span class="copyright">© GMCL</span>
	<span id="datetime"></span>
  </div>
<script src="/assets/scripts/script_time.js"></script>
</footer>


</div>
  </body>
</html>
